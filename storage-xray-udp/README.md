# storage-xray-udp

Encoding and wire protocol for sending Zipkin spans to AWS X-Ray.

See [reporter-xray-udp](../reporter-xray-udp) for instructions on setting up
X-Ray reporting for an application.

## Overview
This storage module performs three activites:
 1. Receives incoming zipkin spans
 2. Encodes received zipkin spans to X-Ray compatible segments
 3. Forwards the encoded X-Ray segments to a X-Ray daemon endpoint

The encoder is implemented by `zipkin2.storage.xray_udp.UDPMessageEncoder` class.

The encoding step maps span attributes to corresponding X-Ray attributes. Majority of attributes involve simple value mappings. There are, however, some fields like `traceId`, `name` that require some additional processing to make them compatible with X-Ray.

### Mapping: TraceId
#### Problem
Both zipkin and X-Ray expect spans and segments respectively from the same trace to have the same trace ID value for the spans or segments to be correlated into a single trace. As per zipkin spec, `traceId`s are `128 bit` *randomly* generated Hex strings. However, X-Ray service expects `trace_id`s to incorporate a `32 bit` *epoch* value capturing the time the trace was generated. As a result blindly mapping the `traceId` field of a span to `trace_id` field of a segment leads to invalid epoch values being interpreted by the X-Ray services.

#### Solution
A new method (`traceEpoch`) has been introduced to calculate the `32 bit` epoch value from `span.timespamp` for insertion at the expected location while mapping to the `trace_id` field. If `span.timestamp` is unavailable then the current epoch value is computed and inserted. In addition a cache has been introduced to satisfy the correlation requirement, which will store a mapping of the incoming `traceId` and the generated `32 bit` epoch value. All subsequent spans with the same `traceId` will get the epoch value from the cache. The cache has a default size of `1000` cached entries with a TTL of `3600` seconds. These cache settings can be customized using environment variables as listed in the Environment Variables section.

A dependency on Google's Guava framework has been added to achieve cache TTL expiry.

### Mapping: Name
#### Problem
As per X-Ray specifications, segment names are constrained to Unicode alpha-numeric characters, whitespaces and the following special characters: `_`, `.`, `:`, `/`, `%`, `&`, `#`, `=`, `+`, `\`, `-`, `@`.
Evidently the asterisk (`*`) character is an illegal character for X-Ray segment names. This creates a problem because spans generated by mesh envoy proxies in some cases contain asterisk character in the span names.

#### Solution
To address the issue a new method (`replaceAsteriskInName`) has been introduced to replace the asterisk character with a valid special character during encoding. This avoids segments with asterisk character(s) in their names failing altogether. Please refer to environment variable `AWS_XRAY_NAME_REPLACE_ASTERISK_WITH_CHAR` in the Environment Variables section for more details.

## Environment Variables
Use the following environment variables to customize the storage settings.

| Name | Mapped Java Type | Default | Valid Values | Purpose |
|------|-----------|---------|--------------|---------|
| `AWS_XRAY_NAME_REPLACE_ASTERISK_WITH_CHAR` | `char` | `null` | Any valid character as per AWS X-Ray segment `name` specification. | If specified replaces invalid `*` character in segment names with the specified caracter. |
| `AWS_XRAY_ORIGIN` | `String` | `ServiceMesh::Istio` | Supported origin values as per AWS X-Ray segment `origin` specification. | Value to populate the `origin` field of the X-Ray segment document. |
| `AWS_XRAY_CACHE_SIZE` | `long` | `1000` | Positive non-zero long values. | Maximum number of entries in the in-memory cache. Set it based on allocatable process memory. |
| `AWS_XRAY_CACHE_TTL_SECONDS` | `long` | `3600` | Positive non-zero long values. | TTL of individual mapping entry. Set it based on how far apart in time spans in a trace can be generated. |

## Future Enhancements

- [ ] Externalize cache layer
